{{ require_js('https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js') }}
{{ require_js('https://unpkg.com/@lottiefiles/lottie-interactivity@latest/dist/lottie-interactivity.min.js') }}

{# Activate when in view - uses Intersection Observer for better performance #}
{% if module.activate_in_view %}
{% require_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    var lottieId = "{{ module.custom_id|default('lottie-' ~ name, true) }}";
    var player = document.getElementById(lottieId);
    if (player) {
        player.addEventListener('ready', function() {
            player.stop();
        });

        var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    {% if module.delay %}
                    setTimeout(function() {
                        player.play();
                    }, {{ module.delay * 1000 }});
                    {% else %}
                    player.play();
                    {% endif %}
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.2 });

        observer.observe(player);
    }
});
</script>
{% end_require_js %}
{% elif module.autoplay and module.delay %}
{# Delay functionality - only applies when autoplay is enabled and delay > 0 #}
{% require_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    var lottieId = "{{ module.custom_id|default('lottie-' ~ name, true) }}";
    var player = document.getElementById(lottieId);
    if (player) {
        player.addEventListener('ready', function() {
            player.stop();
            setTimeout(function() {
                player.play();
            }, {{ module.delay * 1000 }});
        });
    }
});
</script>
{% end_require_js %}
{% endif %}
{% set attrs = {} %}

{% if module.play_mode == 'bounce' %}
  {% do attrs.update({ mode: 'bounce' }) %}
{% endif %}

{% set bg_color = module.background_color.color|convert_rgb %}
{% set opacity = module.background_color.opacity != null ? module.background_color.opacity / 100 : 1 %}

{% do attrs.update({ background: 'rgba(%s,%s)' | format(bg_color, opacity) }) %}
{% do attrs.update({ speed: module.animation_speed }) %}
{% do attrs.update({ style: 'width: %s; height: %s'|format(module.width, module.height) }) %}

{% if module.direction == '-1' %}
  {% do attrs.update({ direction: -1 }) %}
{% endif %}

{% if module.controls %}
  {% do attrs.update({ controls: true }) %}
{% endif %}

{% if module.hover %}
  {% do attrs.update({ hover: true }) %}
{% endif %}

{% if module.autoplay and not module.activate_in_view %}
  {% do attrs.update({ autoplay: true }) %}
{% endif %}

{% if module.delay %}
  {% do attrs.update({ delay: module.delay }) %}
{% endif %}

{% if module.loop %}
  {% do attrs.update({ loop: true }) %}
{% endif %}

{% if is_in_editor %}
<!-- Editor Preview -->
<div
    {%if module.custom_id%} id="{{module.custom_id}}" {% endif %}
    {% if module.custom_class %} class="{{module.custom_class}}" {% endif %}
    style="width: 100%; height: {{module.height}}; background: rgba({{bg_color}},{{opacity}}); display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; color: #666; font-family: Arial, sans-serif;"
>
    <div style="text-align: center;">
        <div style="font-size: 18px; margin-bottom: 8px;">ðŸŽ¬</div>
        <div>Lottie Animation</div>
        <div style="font-size: 12px; margin-top: 4px;">Preview on live page</div>
    </div>
</div>
{% else %}
<!-- Live Site -->
{% set player_id = module.custom_id|default('lottie-' ~ name, true) %}
<lottie-player
    id="{{ player_id }}"
    {% if module.custom_class %} class="{{module.custom_class}}" {% endif %}
    src="{{ module.source }}"
    {{ attrs|xmlattr }}>
</lottie-player>
{% endif %}

